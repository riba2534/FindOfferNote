# 《Linux内核设计与实现》第三章：进程管理

## 3.1 进程

- 进程是处于执行期的程序。并不局限于一段可执行的程序代码，也包括了打开的文件、挂起的信号、内核内部数据、处理器状态，一个或多个具有内存映射的内存地址空间以及一个或多个执行线程。
- 进程是处于执行期的程序以及相关资源的总称。
- 线程是在进程中活动的对象。
- 内核的调度对象是线程，不是进程。对Linux而言，线程是一种特殊的进程
- 进程可以提供两种虚拟机制：虚拟处理器和虚拟内存，虚拟处理器给进程一种假象，让进程以为自己在独享处理器

## 3.2 进程描述符及任务结构

### 进程描述符

Linux把进程的列表存放在叫做任务队列的双向循环链表中。链表中的每一项都是 `task_struct`

在 `include/linux/sched.h` 1170行 中定义了一个进程的结构，称为**「进程描述符」**。

这个结构体完整的描述了内核管理进程所需的所有信息：打开的文件、进程的地址空间、挂起的信号、进程的状态和其他一些信息。

```c
struct task_struct {
	volatile long state;	/* -1 unrunnable, 0 runnable, >0 stopped */
	void *stack;
	atomic_t usage;
	unsigned int flags;	/* per process flags, defined below */
	unsigned int ptrace;

	int lock_depth;		/* BKL lock depth */
  
    /// 省略....
};
```

进程信息的描述在 `arch/x86/include/asm/thread_info.h` 26 行中：

```c
struct thread_info {
	struct task_struct	*task;		/* main task structure */
	struct exec_domain	*exec_domain;	/* execution domain */
	__u32			flags;		/* low level flags */
	__u32			status;		/* thread synchronous flags */
	__u32			cpu;		/* current CPU */
	int			preempt_count;	/* 0 => preemptable,
						   <0 => BUG */
	mm_segment_t		addr_limit;
	struct restart_block    restart_block;
	void __user		*sysenter_return;
#ifdef CONFIG_X86_32
	unsigned long           previous_esp;   /* ESP of the previous stack in
						   case of nested (IRQ) stacks
						*/
	__u8			supervisor_stack[0];
#endif
	int			uaccess_err;
};
```

现在使用 slab 分配器动态生成 `task_struct` ，栈底或者栈顶创建一个新的结构。

![image-20200901234643817](https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200901234650.png)

内核通过唯一的一个进程标识值或者PID来表示每个进程，PID 默认值最大是 `32768` （short int 的最大值），值的大小在 `include/linux/threads.h` 中定义.

### 进程状态

五种状态：

- `TASK_RUNNING` 运行态：进程是可执行的，或者正在执行，或者在运行队列中等待执行
- `TASK_INTERRUPTIBLE` （可中断）：也就是被阻塞，进程正在睡眠，等待某些条件打成。一旦这些条件达成，内核会把状态改为运行
- `TASK_UNINTERRUPTIBLE`（不可中断）：除了就算是接收到信号也不会被唤醒或准备投入运行外，这个状态与可打断状态相同。由于此状态的任务信号不做相应，所以较于可中断状态，用的比较少。
- `__TASK_TRACED`：被其他进程跟踪的进程
- `__TASK_STOPPED`（停止）：进程停止进行。

![image-20200902001238747](https://image-1252109614.cos.ap-beijing.myqcloud.com/img/20200902001238.png)

